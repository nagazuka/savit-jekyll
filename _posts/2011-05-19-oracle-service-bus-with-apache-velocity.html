---
layout: blogpost
title: Use Oracle Service Bus 11g as a Templating Engine with Apache Velocity
tags:
- 11g
- apache velocity
- fusion middleware
- java callout
- oracle service bus
- Oracle Service Bus
- osb
- tutorial
- web service
status: publish
type: post
published: true
meta:
  tumblr_nagazuka_permalink: http://nagazuka.nl/post/5635802332/oracle-service-bus-with-apache-velocity
  tumblr_nagazuka_id: '5635802332'
  _edit_last: '1'
  _thumbnail_id: '43'
---
<strong>Goal</strong>
<ul>
	<li>Create a Web Service with Oracle service Bus 11g that renders a template with the Apache Velocity templating engine.</li>
	<li>Learn about Java callouts in OSB with dependencies on external libraries</li>
</ul>
<strong>Why?</strong>

For example: To render templates for e-mails to send out with Oracle Service Bus 11g.

With Apache Velocity you have a well-known and widely-used templating engine, to render for instance HTML content. After rendering this content can be uploaded with FTP or e-mailed with OSB.

<strong>Overview</strong>

The diagram below shows the overview of the components needed to make this work.

<a href="http://www.nagazuka.nl/wp-content/uploads/2011/07/tumblr_llfxfvretG1qa552a.png"><img class="size-full wp-image-43 alignnone" title="osb_velocity_overview" src="http://www.nagazuka.nl/wp-content/uploads/2011/07/tumblr_llfxfvretG1qa552a.png" alt="Overview of OSB and Apache Velocity integration" width="500" height="298" /></a>

<strong>How</strong>

<em>Prerequisites: </em>
<ul>
	<li>    Weblogic 11g (10.1.3.5.0) installed with Oracle Service Bus 11gR1 (11.1.1.4.0)</li>
	<li>    Oracle Service Bus 11g domain configured and running</li>
	<li>    Oracle Enterprise Pack for Eclipse</li>
</ul>
<em>  Steps</em>

For development I use the Oracle Enterprise Pack for Eclipse, which is downloadable from OTN.

<strong>1)</strong> Create a TemplateUtilities JAR for use in Oracle Service Bus
<ul>
	<li>Create new Java Project <strong>TemplateUtilities</strong></li>
	<li>Add external libraries to Build Path of project
- Apache Velocity jar: velocity-1.7-dep.jar
- XMLBeans jar: xmlbeans-1.0.3.jar</li>
</ul>
The Apache Velocity jar will serve as our templating engine, while XMLBeans is required because we are using an XML message for the Java callout input.
<ul>
	<li>Add a new class that will serve the Java callout in OSB called <span><a title="TemplateUtilities.java" href="https://github.com/nagazuka/OSBWithVelocityTemplating/blob/master/TemplateUtilities/src/nl/nagazuka/service/example/template/TemplateUtilities.java" target="_blank">TemplateUtilities.java</a></span><strong>
</strong></li>
</ul>
This code reads the XML request
<blockquote>   String templateName = getTemplateName(renderTemplateReq);

Map&lt;String, String&gt; params = getParameters(renderTemplateReq);</blockquote>
The XML input for the renderTemplate method should be formatted as:
<blockquote>&lt;renderTemplate&gt;

&lt;templateName&gt;RenderMe.vm&lt;/templateName&gt;

&lt;parameters&gt;

&lt;parameter&gt;

&lt;key&gt;VARIABLE_NAME&lt;/key&gt;

&lt;value&gt;VALUE&lt;/value&gt;

&lt;/parameter&gt;

&lt;/parameters&gt;

&lt;/renderTemplate&gt;</blockquote>
It looks for <strong>velocity.properties</strong> (configuration for Apache Velocity on where to find the templates) <strong>on the classpath</strong>
<blockquote>        URL url = ClassLoader.getSystemResource(VELOCITY_PROPERTIES);</blockquote>
In the last part, the Velocity template is rendered with the supplied parameters and a String with the result is returned.
<blockquote>        Velocity.mergeTemplate(templateName, “UTF-8”, context, w);

…

return w.toString();</blockquote>
<strong>2)</strong> Export Java project from Eclipse to JAR file so we can use it in Oracle Service Bus 11g

<strong>3)</strong> Create a WSDL that defines the interface of our new webservice <strong>TemplateService_v1.wsdl</strong>
<ul>
	<li>Input: template name and list of key-value parameters</li>
	<li>Output: a string with the rendered template</li>
</ul>
<strong>4)</strong> Create a new Proxy Service <strong>TemplateService_v1</strong>
<ul>
	<li>Create a new Oracle Service Bus Configuration Project to contain our new Project</li>
	<li>Create a new Oracle Service Bus Project in the Configuration Project</li>
	<li>Create a new Proxy Service <strong>TemplateService_v1 </strong>using our created WSDL binding</li>
	<li>Add <strong>TemplateUtilities.jar</strong> to TemplateService project</li>
	<li>In the message flow add a Pipeline pair in which we will process the request</li>
	<li>Add a Stage in the request pipeline with two actions:</li>
	<li>an Assign action to create the request to the variable <strong>$renderTemplateRequest</strong>. For simplicity let’s do it hardcoded (use example request above).</li>
	<li>a Java callout that uses the TemplateUtilities
- Select the renderTemplateMethod
- Use <strong>$renderTemplateRequest</strong> as the input
- Assign Result Value to <strong>$renderTemplateResponse
</strong><a href="http://www.nagazuka.nl/wp-content/uploads/2011/07/tumblr_llfxrcRrxo1qa552a.png"><img class="size-full wp-image-45 alignnone" title="java_callout" src="http://www.nagazuka.nl/wp-content/uploads/2011/07/tumblr_llfxrcRrxo1qa552a.png" alt="Java Callout Configuration" width="500" height="168" /></a><strong> </strong></li>
	<li>Add a Stage in the response pipeline with an Assign action that inserts the rendered template in to the service response<a href="http://www.nagazuka.nl/wp-content/uploads/2011/07/tumblr_llfxpawFfc1qa552a.png"><img class="size-full wp-image-46 alignnone" title="proxy_service_config" src="http://www.nagazuka.nl/wp-content/uploads/2011/07/tumblr_llfxpawFfc1qa552a.png" alt="OSB Proxy Service Configuration with Java Callout" width="483" height="551" /></a></li>
</ul>
<strong>4)</strong> Deploy and test the Oracle Service Bus 11g powered template engine!
<ul>
	<li>Deploy using Export to Oracle Service Bus - Resources to Server</li>
	<li>Execute with Test Console</li>
</ul>
Complete code can be found on <a title="nagazuka's Github" href="https://github.com/nagazuka/OSBWithVelocityTemplating/" target="_blank">nagazuka’s GitHub</a>!
